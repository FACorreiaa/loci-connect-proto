syntax = "proto3";

package loci.review.v1;

option go_package = "github.com/FACorreiaa/loci-connect-proto/gen/go/loci/review/v1;reviewv1";

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "loci/common/common.proto";


// ReviewService provides review and rating functionality for POIs
service ReviewService {
  // Create a new review
  rpc CreateReview(CreateReviewRequest) returns (CreateReviewResponse);
  
  // Get reviews for a POI
  rpc GetPOIReviews(GetPOIReviewsRequest) returns (GetPOIReviewsResponse);
  
  // Get a specific review
  rpc GetReview(GetReviewRequest) returns (GetReviewResponse);
  
  // Update an existing review
  rpc UpdateReview(UpdateReviewRequest) returns (UpdateReviewResponse);
  
  // Delete a review
  rpc DeleteReview(DeleteReviewRequest) returns (DeleteReviewResponse);
  
  // Get user's reviews
  rpc GetUserReviews(GetUserReviewsRequest) returns (GetUserReviewsResponse);
  
  // Like/unlike a review
  rpc LikeReview(LikeReviewRequest) returns (LikeReviewResponse);
  
  // Report a review
  rpc ReportReview(ReportReviewRequest) returns (ReportReviewResponse);
  
  // Get review statistics for a POI
  rpc GetReviewStatistics(GetReviewStatisticsRequest) returns (GetReviewStatisticsResponse);
}

// Core review entity
message Review {
  string id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string user_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string poi_id = 3 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  double rating = 4 [(buf.validate.field).double = {gte: 1, lte: 5}]; // 1.0 - 5.0
  string title = 5 [(buf.validate.field).string = {min_len: 1, max_len: 200}];
  string content = 6 [(buf.validate.field).string = {min_len: 1, max_len: 4000}];
  repeated string photos = 7 [(buf.validate.field).repeated = {
    max_items: 10,
    items: {string: {min_len: 1, max_len: 2048, uri: true}}
  }]; // Photo URLs
  ReviewStatus status = 8 [(buf.validate.field).enum = {defined_only: true}];
  google.protobuf.Timestamp visit_date = 9;
  google.protobuf.Timestamp created_at = 10 [(buf.validate.field).required = true];
  google.protobuf.Timestamp updated_at = 11 [(buf.validate.field).required = true];
  
  // Review metadata
  int32 helpful_count = 12 [(buf.validate.field).int32 = {gte: 0}]; // Number of helpful votes
  int32 report_count = 13 [(buf.validate.field).int32 = {gte: 0}]; // Number of reports
  bool is_verified = 14; // Verified reviewer
  string language = 15 [(buf.validate.field).string = {
    min_len: 2,
    max_len: 10,
    pattern: "^[a-z]{2}(-[A-Z]{2})?$"  // ISO 639-1 format (e.g., en, en-US)
  }]; // ISO 639-1 language code
  
  // Review aspects (detailed ratings)
  ReviewAspects aspects = 16;
  
  // User information (public)
  ReviewerInfo reviewer = 17;
  
  // Response from business owner
  BusinessResponse business_response = 18;
}

// Review status
enum ReviewStatus {
  REVIEW_STATUS_UNSPECIFIED = 0;
  REVIEW_STATUS_PENDING = 1; // Awaiting moderation
  REVIEW_STATUS_PUBLISHED = 2; // Live and visible
  REVIEW_STATUS_HIDDEN = 3; // Hidden by moderator
  REVIEW_STATUS_DELETED = 4; // Deleted by user or admin
  REVIEW_STATUS_FLAGGED = 5; // Flagged for review
}

enum SortDirection {
  SORT_DIRECTION_UNSPECIFIED = 0;
  SORT_DIRECTION_ASC = 1;
  SORT_DIRECTION_DESC = 2;
}

// Detailed aspects of a review
message ReviewAspects {
  double service_rating = 1 [(buf.validate.field).double = {gte: 1, lte: 5}]; // 1.0 - 5.0
  double quality_rating = 2 [(buf.validate.field).double = {gte: 1, lte: 5}];
  double value_rating = 3 [(buf.validate.field).double = {gte: 1, lte: 5}];
  double atmosphere_rating = 4 [(buf.validate.field).double = {gte: 1, lte: 5}];
  double cleanliness_rating = 5 [(buf.validate.field).double = {gte: 1, lte: 5}];
  double location_rating = 6 [(buf.validate.field).double = {gte: 1, lte: 5}];

  // Restaurant-specific
  double food_rating = 7 [(buf.validate.field).double = {gte: 1, lte: 5}];

  // Hotel-specific
  double room_rating = 8 [(buf.validate.field).double = {gte: 1, lte: 5}];
  double amenities_rating = 9 [(buf.validate.field).double = {gte: 1, lte: 5}];
  double staff_rating = 10 [(buf.validate.field).double = {gte: 1, lte: 5}];
}

// Public reviewer information
message ReviewerInfo {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string display_name = 2 [(buf.validate.field).string = {min_len: 1, max_len: 200}];
  string avatar_url = 3 [(buf.validate.field).string = {
    max_len: 2048,
    uri: true  // URL validation
  }];
  int32 review_count = 4 [(buf.validate.field).int32 = {gte: 0}];
  bool is_verified = 5;
  string level = 6 [(buf.validate.field).string = {min_len: 1, max_len: 50}]; // "Bronze", "Silver", "Gold", "Platinum"
  google.protobuf.Timestamp member_since = 7 [(buf.validate.field).required = true];
}

// Business response to a review
message BusinessResponse {
  string id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string business_user_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string content = 3 [(buf.validate.field).string = {min_len: 1, max_len: 2000}];
  google.protobuf.Timestamp created_at = 4 [(buf.validate.field).required = true];
  string responder_name = 5 [(buf.validate.field).string = {min_len: 1, max_len: 200}];
  string responder_title = 6 [(buf.validate.field).string = {min_len: 1, max_len: 200}];
}

// Review statistics for a POI
message ReviewStatistics {
  string poi_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  double overall_rating = 2 [(buf.validate.field).double = {gte: 0, lte: 5}];
  int32 total_reviews = 3 [(buf.validate.field).int32 = {gte: 0}];
  RatingBreakdown rating_breakdown = 4;
  ReviewAspectAverages aspect_averages = 5;
  RecentReviewTrends trends = 6;
  repeated ReviewTag tags = 7; // Most mentioned tags/keywords
  LanguageDistribution language_distribution = 8;
  google.protobuf.Timestamp last_updated = 9;
}

message RatingBreakdown {
  int32 one_star = 1 [(buf.validate.field).int32 = {gte: 0}];
  int32 two_star = 2 [(buf.validate.field).int32 = {gte: 0}];
  int32 three_star = 3 [(buf.validate.field).int32 = {gte: 0}];
  int32 four_star = 4 [(buf.validate.field).int32 = {gte: 0}];
  int32 five_star = 5 [(buf.validate.field).int32 = {gte: 0}];
}

// Average ratings for review aspects
message ReviewAspectAverages {
  double service_average = 1 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double quality_average = 2 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double value_average = 3 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double atmosphere_average = 4 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double cleanliness_average = 5 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double location_average = 6 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double food_average = 7 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double room_average = 8 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double amenities_average = 9 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double staff_average = 10 [(buf.validate.field).double = {gte: 0, lte: 5}];
}

// Review trends over time
message RecentReviewTrends {
  double rating_trend = 1; // Positive/negative trend
  int32 reviews_last_30_days = 2 [(buf.validate.field).int32 = {gte: 0}];
  double average_rating_last_30_days = 3 [(buf.validate.field).double = {gte: 0, lte: 5}];
  double rating_change_percentage = 4;
  repeated MonthlyReviewData monthly_data = 5;
}

message MonthlyReviewData {
  int32 year = 1 [(buf.validate.field).int32 = {gte: 0}];
  int32 month = 2 [(buf.validate.field).int32 = {gte: 1, lte: 12}];
  int32 review_count = 3 [(buf.validate.field).int32 = {gte: 0}];
  double average_rating = 4 [(buf.validate.field).double = {gte: 0, lte: 5}];
}

// Review tags/keywords
message ReviewTag {
  string tag = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  int32 count = 2 [(buf.validate.field).int32 = {gte: 0}];
  double sentiment_score = 3 [(buf.validate.field).double = {gte: -1, lte: 1}]; // -1.0 to 1.0
  string category = 4 [(buf.validate.field).string = {min_len: 1, max_len: 50}]; // "positive", "negative", "neutral"
}

// Language distribution of reviews
message LanguageDistribution {
  repeated LanguageCount languages = 1;
}

message LanguageCount {
  string language_code = 1 [(buf.validate.field).string = {min_len: 2, max_len: 10}];
  string language_name = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  int32 count = 3 [(buf.validate.field).int32 = {gte: 0}];
  double percentage = 4 [(buf.validate.field).double = {gte: 0, lte: 100}];
}

// Review filter options
message ReviewFilter {
  repeated double rating_filters = 1 [(buf.validate.field).repeated = {
    max_items: 5,
    items: {double: {gte: 1, lte: 5}}
  }]; // Filter by specific ratings
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  repeated string languages = 4 [(buf.validate.field).repeated = {
    max_items: 10,
    items: {string: {min_len: 2, max_len: 10, pattern: "^[a-z]{2}(-[A-Z]{2})?$"}}
  }];
  bool verified_only = 5;
  bool with_photos_only = 6;
  repeated string keywords = 7 [(buf.validate.field).repeated = {
    max_items: 20,
    items: {string: {min_len: 1, max_len: 100}}
  }];
  ReviewSortBy sort_by = 8;
  SortDirection sort_direction = 9;
}

// Sort options for reviews
enum ReviewSortBy {
  REVIEW_SORT_BY_UNSPECIFIED = 0;
  REVIEW_SORT_BY_DATE = 1; // Most recent first
  REVIEW_SORT_BY_RATING = 2; // Highest rating first
  REVIEW_SORT_BY_HELPFUL = 3; // Most helpful first
  REVIEW_SORT_BY_RELEVANCE = 4; // Algorithm-determined relevance
}

// Request/Response messages
message CreateReviewRequest {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string poi_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  double rating = 3 [(buf.validate.field).double = {gte: 1, lte: 5}];
  string title = 4 [(buf.validate.field).string = {min_len: 1, max_len: 200}];
  string content = 5 [(buf.validate.field).string = {min_len: 1, max_len: 4000}];
  repeated string photo_urls = 6 [(buf.validate.field).repeated = {
    max_items: 10,
    items: {string: {min_len: 1, max_len: 2048, uri: true}}
  }];
  google.protobuf.Timestamp visit_date = 7;
  ReviewAspects aspects = 8;
  string language = 9 [(buf.validate.field).string = {
    min_len: 2,
    max_len: 10,
    pattern: "^[a-z]{2}(-[A-Z]{2})?$"  // ISO 639-1 format (e.g., en, en-US)
  }];
}

message CreateReviewResponse {
  loci.common.Response response = 1;
  Review review = 2;
}

message GetPOIReviewsRequest {
  string poi_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  loci.common.PaginationRequest pagination = 2;
  ReviewFilter filter = 3;
}

message GetPOIReviewsResponse {
  repeated Review reviews = 1;
  loci.common.PaginationMetadata pagination = 2;
  ReviewStatistics statistics = 3;
}

message GetReviewRequest {
  string review_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string user_id = 2 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {max_len: 100}
  ]; // Optional, for permission checking
}

message GetReviewResponse {
  Review review = 1;
  bool can_edit = 2;
  bool can_delete = 3;
}

message UpdateReviewRequest {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string review_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  double rating = 3 [(buf.validate.field).double = {gte: 1, lte: 5}];
  string title = 4 [(buf.validate.field).string = {min_len: 1, max_len: 200}];
  string content = 5 [(buf.validate.field).string = {min_len: 1, max_len: 4000}];
  repeated string photo_urls = 6 [(buf.validate.field).repeated = {
    max_items: 10,
    items: {string: {min_len: 1, max_len: 2048, uri: true}}
  }];
  google.protobuf.Timestamp visit_date = 7;
  ReviewAspects aspects = 8;
}

message UpdateReviewResponse {
  loci.common.Response response = 1;
  Review review = 2;
}

message DeleteReviewRequest {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string review_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
}

message DeleteReviewResponse {
  loci.common.Response response = 1;
}

message GetUserReviewsRequest {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  loci.common.PaginationRequest pagination = 2;
  ReviewFilter filter = 3;
}

message GetUserReviewsResponse {
  repeated Review reviews = 1;
  loci.common.PaginationMetadata pagination = 2;
  UserReviewStatistics statistics = 3;
}

message UserReviewStatistics {
  int32 total_reviews = 1 [(buf.validate.field).int32 = {gte: 0}];
  double average_rating_given = 2 [(buf.validate.field).double = {gte: 0, lte: 5}];
  int32 helpful_votes_received = 3 [(buf.validate.field).int32 = {gte: 0}];
  string reviewer_level = 4 [(buf.validate.field).string = {min_len: 1, max_len: 50}];
  repeated string top_categories_reviewed = 5;
}

message LikeReviewRequest {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string review_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  bool is_like = 3; // true for like, false for unlike
}

message LikeReviewResponse {
  loci.common.Response response = 1;
  int32 new_helpful_count = 2;
}

message ReportReviewRequest {
  string user_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string review_id = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string reason = 3 [(buf.validate.field).string = {min_len: 1, max_len: 200}]; // "spam", "inappropriate", "fake", "offensive"
  string details = 4 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {max_len: 1000}
  ];
}

message ReportReviewResponse {
  loci.common.Response response = 1;
}

message GetReviewStatisticsRequest {
  string poi_id = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  bool include_trends = 2;
  bool include_tags = 3;
}

message GetReviewStatisticsResponse {
  ReviewStatistics statistics = 1;
}
