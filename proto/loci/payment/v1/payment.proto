syntax = "proto3";

package loci.payment.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/FACorreiaa/loci-connect-proto/gen/go/loci/payment/v1;paymentv1";

service PaymentService {
  // Payments
  rpc CreatePayment(CreatePaymentRequest) returns (CreatePaymentResponse);
  rpc GetPayment(GetPaymentRequest) returns (GetPaymentResponse);
  rpc GetUserPayments(GetUserPaymentsRequest) returns (GetUserPaymentsResponse);
  rpc RefundPayment(RefundPaymentRequest) returns (RefundPaymentResponse); // Admin or constrained

  // Invoices
  rpc GetInvoice(GetInvoiceRequest) returns (Invoice);
  rpc GetUserInvoices(GetUserInvoicesRequest) returns (GetUserInvoicesResponse);

  // Subscriptions
  rpc CreateSubscription(CreateSubscriptionRequest) returns (CreateSubscriptionResponse);
  rpc CancelSubscription(CancelSubscriptionRequest) returns (CancelSubscriptionResponse);
  rpc GetUserSubscriptions(GetUserSubscriptionsRequest) returns (GetUserSubscriptionsResponse);
  rpc GetSubscription(GetSubscriptionRequest) returns (GetSubscriptionResponse);

  // Stripe Checkout & Portal
  rpc CreateCheckoutSession(CreateCheckoutSessionRequest) returns (CreateCheckoutSessionResponse);
  rpc CreateCustomerPortalSession(CreateCustomerPortalSessionRequest) returns (CreateCustomerPortalSessionResponse);
}

// --- Common Messages ---

message Payment {
  string id = 1;
  string user_id = 2;
  string provider = 3; // e.g. "stripe"
  string external_payment_id = 4;
  string type = 5; // "one_time", "subscription"
  string payment_method = 6;
  int64 amount = 7;
  string currency = 8;
  string status = 9; // "succeeded", "pending", "failed"
  string description = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp updated_at = 12;
}

message Invoice {
  string id = 1;
  string payment_id = 2;
  string invoice_number = 3;
  string user_id = 4;
  int64 amount = 5;
  string currency = 6;
  string status = 7;
  string pdf_url = 8;
  google.protobuf.Timestamp issued_at = 9;
  google.protobuf.Timestamp paid_at = 10;
}

message Subscription {
  string id = 1;
  string user_id = 2;
  string plan_id = 3;
  string status = 4; // "active", "canceled", etc.
  string stripe_subscription_id = 5;
  string stripe_customer_id = 6;
  google.protobuf.Timestamp current_period_start = 7;
  google.protobuf.Timestamp current_period_end = 8;
  bool cancel_at_period_end = 9;
}

// --- Requests/Responses ---

message CreatePaymentRequest {
  int64 amount = 1;
  string currency = 2;
  string type = 3;
  string description = 4;
  map<string, string> metadata = 5;
}

message CreatePaymentResponse {
  string payment_id = 1;
  string client_secret = 2;
  string external_payment_id = 3;
  string status = 4;
}

message GetPaymentRequest {
  string payment_id = 1;
}

message GetPaymentResponse {
  Payment payment = 1;
  Invoice invoice = 2;
}

message GetUserPaymentsRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message GetUserPaymentsResponse {
  repeated Payment payments = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message RefundPaymentRequest {
  string payment_id = 1;
  int64 amount_cents = 2; // Optional, defaults to full if 0/missing logic handles it
  string reason = 3;
}

message RefundPaymentResponse {
  string refund_id = 1;
  string payment_id = 2;
  int64 amount_cents = 3;
  string currency = 4;
  string status = 5;
  int64 total_refunded = 6;
  bool is_full_refund = 7;
}

message GetInvoiceRequest {
  string invoice_id = 1;
}

message GetUserInvoicesRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message GetUserInvoicesResponse {
  repeated Invoice invoices = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message CreateSubscriptionRequest {
  string plan_id = 1; // e.g. price_123... or our internal plan ID
  string payment_method_id = 2; // Stripe PaymentMethod ID if immediate charge
}

message CreateSubscriptionResponse {
  string subscription_id = 1;
  string client_secret = 2; // For SetupIntent or PaymentIntent if 3DS needed
  string status = 3;
}

message CancelSubscriptionRequest {
  string subscription_id = 1;
  bool cancel_at_period_end = 2;
}

message CancelSubscriptionResponse {
  string subscription_id = 1;
  string status = 2;
}

message GetUserSubscriptionsRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message GetUserSubscriptionsResponse {
  repeated Subscription subscriptions = 1;
}

// --- GetSubscription (single subscription with usage) ---

message GetSubscriptionRequest {
  // Empty - uses authenticated user's subscription
}

message GetSubscriptionResponse {
  Subscription subscription = 1;
  SubscriptionUsage usage = 2;
}

message SubscriptionUsage {
  int32 requests_today = 1;
  int32 requests_limit = 2;
  int32 saved_locations = 3;
  int32 saved_locations_limit = 4;
}

// --- Checkout Session ---

message CreateCheckoutSessionRequest {
  string price_id = 1;         // Stripe Price ID (price_xxx)
  string success_url = 2;      // URL to redirect on success
  string cancel_url = 3;       // URL to redirect on cancel
  string mode = 4;             // "subscription" or "payment"
}

message CreateCheckoutSessionResponse {
  string session_id = 1;       // Stripe Checkout Session ID
  string url = 2;              // Redirect URL for the user
}

// --- Customer Portal Session ---

message CreateCustomerPortalSessionRequest {
  string return_url = 1;       // URL to return to after portal session
}

message CreateCustomerPortalSessionResponse {
  string session_id = 1;       // Stripe Portal Session ID
  string url = 2;              // Redirect URL for the user
}
